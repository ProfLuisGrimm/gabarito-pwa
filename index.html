<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gabarito Digital</title>
<style>
  :root { --bubble: 22px; }

  /* ===== Base ===== */
  body { font-family: Arial, sans-serif; margin: 16px; background:#f7f7f7; color:#111; }
  .menu { display:flex; gap:8px; margin-bottom:12px; }
  .menu button { padding:8px 12px; font-weight:600; cursor:pointer; }
  #exitBtn {
    position: fixed; top:10px; right:10px; z-index:1000;
    padding:6px 10px; background:#e74c3c; color:#fff; border:0; border-radius:6px;
    font-weight:700; cursor:pointer; font-size:14px;
  }

  /* Screens */
  .screen { display:none; }
  .screen.active { display:block; }

  /* Controls */
  .controls { margin-bottom: 16px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  .controls label { display:flex; flex-direction:column; font-size:14px; }
  .controls input[type="number"], .controls select, .controls input[type="range"] { padding:6px; }

  /* Print area / container uses grid for deterministic layouts */
  #printArea { display:block; background:transparent; }
  #sheetContainer {
    display:grid;
    gap: 12px;
    justify-content: center;
    align-items: start;
  }

  .page {
    border: 2px solid #000;
    background:#fff;
    position: relative;
    box-sizing: border-box;
    padding: 14px;
    box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    overflow: visible;
  }

  /* Layouts:
     - layout-1: 1 cartão por folha (centralizado)
     - layout-2: 2 cartões por folha, empilhados (um em cima, outro embaixo)
     - layout-4: 4 cartões por folha, grade 2x2
  */
  .layout-1 { grid-template-columns: 1fr; justify-items: center; }
  .layout-1 .page { width: 18cm; min-height: 26cm; }

  .layout-2 { grid-template-columns: 1fr; justify-items: center; grid-auto-rows: min-content; }
  .layout-2 .page { width: 18cm; min-height: 13cm; }

  .layout-4 { grid-template-columns: repeat(2, 1fr); justify-items: center; }
  .layout-4 .page { width: 9cm; min-height: 13cm; }

  /* Header & question styles */
  .headerCard { margin-bottom: 10px; font-size: 14px; line-height: 1.6; }
  .nowrap { white-space: nowrap; }

  .question { margin-bottom: 8px; font-size: 14px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .opts { display:flex; gap:8px; align-items:center; }

  .opt {
    display:inline-flex;
    width: var(--bubble);
    height: var(--bubble);
    border: 1.6px solid #000;
    border-radius: 50%;
    align-items:center;
    justify-content:center;
    font-weight:700;
    user-select:none;
    box-sizing: border-box;
  }

  .versionTag {
    position: absolute;
    bottom: 6px;
    right: 8px;
    font-size: 11px;
    color: #666;
  }

  /* Small helpers */
  .small { font-size: 13px; color:#444; }

  /* Impressão: tornar visível apenas a área de impressão */
  @media print {
    body { margin:0; padding:0; background:#fff; }
    body * { visibility: hidden !important; }
    #printArea, #printArea * { visibility: visible !important; }
    #printArea { position: absolute; left:0; top:0; width:100%; margin: 1cm; }
    .page { page-break-inside: avoid; break-inside: avoid; border: 1px solid #000; }
    /* ocultar controles/menus ao imprimir */
    .controls, .menu, #exitBtn { display:none !important; }
  }
</style>
</head>
<body>

<button id="exitBtn" onclick="window.location.href='https://github.com/seu-usuario/gabarito-pwa';">Sair ×</button>

<div class="menu">
  <button onclick="showScreen('gabaritoScreen')">Configurar Gabarito</button>
  <button onclick="showScreen('escaneamentoScreen')">Escanear Cartão</button>
</div>

<!-- Tela: Configurar Gabarito -->
<div id="gabaritoScreen" class="screen active">
  <div class="controls">
    <label>Quantidade de questões:
      <input type="number" id="numQuestions" value="10" min="1" max="200">
    </label>

    <label>Alternativas:
      <select id="numOptions">
        <option value="4" selected>4 (A–D)</option>
        <option value="5">5 (A–E)</option>
      </select>
    </label>

    <label>Gabaritos por folha:
      <select id="perPage">
        <option value="1" selected>1</option>
        <option value="2">2 (empilhado)</option>
        <option value="4">4 (2x2)</option>
      </select>
    </label>

    <label>Tamanho das bolhas:
      <input type="range" id="bubbleSize" min="14" max="36" value="22">
      <span id="bubbleSizeValue">22</span> px
    </label>

    <button onclick="printSheet()">Imprimir</button>
  </div>

  <!-- Área que será impressa -->
  <div id="printArea">
    <div id="sheetContainer" class="layout-1"></div>
  </div>
</div>

<!-- Tela: Escanear Cartão -->
<div id="escaneamentoScreen" class="screen">
  <div class="controls">
    <label>Upload das turmas (Excel .xlsx ou .csv):
      <input type="file" id="fileInput" multiple>
    </label>

    <label>Turma:
      <select id="selectClass">
        <option value="">-- Selecione --</option>
      </select>
    </label>

    <label>Aluno:
      <select id="selectStudent">
        <option value="">-- Selecione --</option>
      </select>
    </label>

    <label>Nº do aluno:
      <input type="text" id="studentNumber" readonly>
    </label>

    <button onclick="exportResults()">Exportar Excel</button>
  </div>

  <p class="small" style="max-width:700px">
    (Próximo passo) Aqui entra o escaneamento por câmera com confirmação visual e gravação automática.  
    Por enquanto, você já consegue selecionar Turma/Aluno e exportar resultados simulados.
  </p>
</div>

<!-- XLSX (local) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
/* ===================== Versão do código ===================== */
const appVersion = "1.10";
/* =========================================================== */

let studentsData = {};   // { "Turma A": [ {numero, nome}, ... ] }
let results = [];        // placeholder para resultados de escaneamento

/* ===== Navegação ===== */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ===== Elementos UI ===== */
const numQuestionsEl = document.getElementById('numQuestions');
const numOptionsEl   = document.getElementById('numOptions');
const perPageEl      = document.getElementById('perPage');
const bubbleSizeEl   = document.getElementById('bubbleSize');
const bubbleSizeVal  = document.getElementById('bubbleSizeValue');
const sheetContainer = document.getElementById('sheetContainer');

/* Listeners: reagir a mudanças e atualizar visual */
[numQuestionsEl, numOptionsEl, perPageEl].forEach(el => {
  el.addEventListener('change', updateSheet);
});
bubbleSizeEl.addEventListener('input', () => {
  const v = parseInt(bubbleSizeEl.value, 10);
  bubbleSizeVal.textContent = v;
  document.documentElement.style.setProperty('--bubble', v + 'px');
  updateSheet();
});

/* ===== Renderização dos cartões ===== */
function updateSheet() {
  const numQuestions = parseInt(numQuestionsEl.value, 10) || 0;
  const numOptions   = parseInt(numOptionsEl.value, 10) || 4;
  const perPage      = parseInt(perPageEl.value, 10) || 1;

  // Limpeza e classe de layout
  sheetContainer.innerHTML = '';
  sheetContainer.className = '';
  sheetContainer.classList.add(`layout-${perPage}`);

  // Para cada cartão presente na folha
  for (let i = 0; i < perPage; i++) {
    const page = document.createElement('div');
    page.className = 'page';

    // Cabeçalho com underscales
    const header = document.createElement('div');
    header.className = 'headerCard';
    header.innerHTML = `
      <div>
        Nome: <span class="nowrap">______________________________</span>
        &nbsp;&nbsp;&nbsp; Nº: <span class="nowrap">______</span>
      </div>
      <div>
        Turma: <span class="nowrap">____________</span>
        &nbsp;&nbsp;&nbsp; Data: <span class="nowrap">___ / ___ / ______</span>
      </div>
    `;
    page.appendChild(header);

    // Questões
    for (let q = 1; q <= numQuestions; q++) {
      const qDiv = document.createElement('div');
      qDiv.className = 'question';
      const numLabel = document.createElement('div');
      numLabel.textContent = q + '.';
      numLabel.style.minWidth = '26px';
      const optsWrapper = document.createElement('div');
      optsWrapper.className = 'opts';
      for (let o = 0; o < numOptions; o++) {
        const letter = String.fromCharCode(65 + o);
        const span = document.createElement('span');
        span.className = 'opt';
        span.dataset.q = q;
        span.dataset.opt = letter;
        span.textContent = letter;
        optsWrapper.appendChild(span);
      }
      qDiv.appendChild(numLabel);
      qDiv.appendChild(optsWrapper);
      page.appendChild(qDiv);
    }

    // Versão
    const vTag = document.createElement('div');
    vTag.className = 'versionTag';
    vTag.textContent = `Versão ${appVersion}`;
    page.appendChild(vTag);

    sheetContainer.appendChild(page);
  }
}

/* ===== Impressão (só #printArea) ===== */
function printSheet() {
  // O CSS @media print já isola #printArea; basta chamar print()
  window.print();
}

/* ===== Upload Excel (Turmas) ===== */
document.getElementById('fileInput').addEventListener('change', function(e){
  const files = e.target.files;
  for (let f of files) {
    const reader = new FileReader();
    reader.onload = function(ev){
      try {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type:'array' });
        workbook.SheetNames.forEach(sheetName => {
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          // Tenta colunas comuns: "Nº" e "Nome" (case sensitive)
          studentsData[sheetName] = json.map(r => {
            const numero = r['Nº'] ?? r['Nr'] ?? r['Numero'] ?? r['Número'] ?? r['N'] ?? '';
            const nome = r['Nome'] ?? r['name'] ?? r['nome'] ?? '';
            return { numero, nome };
          });
        });
        updateClassOptions();
      } catch (err) {
        console.error(err);
        alert('Erro ao ler arquivo. Verifique o formato do Excel/CSV.');
      }
    };
    reader.readAsArrayBuffer(f);
  }
});

function updateClassOptions(){
  const selectClass = document.getElementById('selectClass');
  selectClass.innerHTML = '<option value="">-- Selecione --</option>';
  Object.keys(studentsData).forEach(c => {
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    selectClass.appendChild(opt);
  });

  // limpa seleções
  document.getElementById('selectStudent').innerHTML = '<option value="">-- Selecione --</option>';
  document.getElementById('studentNumber').value = '';
}

document.getElementById('selectClass').addEventListener('change', function(){
  const turma = this.value;
  const selectStudent = document.getElementById('selectStudent');
  selectStudent.innerHTML = '<option value="">-- Selecione --</option>';
  if (studentsData[turma]) {
    studentsData[turma].forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.nome;
      opt.textContent = s.nome || s.numero || '(sem nome)';
      opt.dataset.numero = s.numero ?? '';
      selectStudent.appendChild(opt);
    });
  }
  document.getElementById('studentNumber').value = '';
});

document.getElementById('selectStudent').addEventListener('change', function(){
  const numero = this.selectedOptions[0]?.dataset?.numero || '';
  document.getElementById('studentNumber').value = numero;
});

/* ===== Exportar Resultados (placeholder) ===== */
function exportResults(){
  if (results.length === 0) {
    alert("Nenhum resultado registrado ainda.");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(results);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Resultados");
  XLSX.writeFile(wb, "Resultados.xlsx");
}

/* ===== Inicialização ===== */
document.documentElement.style.setProperty('--bubble', bubbleSizeEl.value + 'px');
document.getElementById('bubbleSizeValue').textContent = bubbleSizeEl.value;
updateSheet();

</script>
</body>
</html>
