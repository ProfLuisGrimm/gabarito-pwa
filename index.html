<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gabarito Digital</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .menu { margin-bottom: 15px; }
  .menu button { margin-right: 10px; padding: 8px 12px; font-weight:bold; cursor:pointer; }
  .controls { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .controls label { display: flex; flex-direction: column; font-size: 14px; }
  .page { border: 1px solid #000; margin: 5px; padding: 10px; box-sizing: border-box; }
  .question { margin-bottom: 5px; font-size: 12px; }
  #exitBtn { 
    position: fixed; top:10px; right:10px; z-index:1000; 
    padding:5px 10px; background-color:#e74c3c; color:#fff; 
    font-weight:bold; border:none; border-radius:5px; cursor:pointer; 
    font-size:14px;
  }
  .headerCard span { display:inline-block; }
  .underline { border-bottom: 1px solid #000; display: inline-block; margin-left:3px; }
  .underline.double { width: 200px; } /* Nome */
  .underline.standard { width: 50px; } /* Nº, Turma */
  @media print {
    body * { visibility: hidden; }
    #sheetContainer, #sheetContainer * { visibility: visible; }
    #sheetContainer { position: absolute; left:0; top:0; width:100%; }
  }
</style>
</head>
<body>

<button id="exitBtn" onclick="window.location.href='https://github.com/seu-usuario/gabarito-pwa';">
  Sair ✖
</button>

<div class="menu">
  <button onclick="showScreen('gabarito')">Configurar Gabarito</button>
  <button onclick="showScreen('escaneamento')">Escanear Cartão</button>
</div>

<!-- Tela Configuração Gabarito -->
<div id="gabaritoScreen">
  <div class="controls">
    <label>Quantidade de questões:
      <input type="number" id="numQuestions" value="10" min="1" max="50">
    </label>

    <label>Alternativas:
      <select id="numOptions">
        <option value="4" selected>4 (A-D)</option>
        <option value="5">5 (A-E)</option>
      </select>
    </label>

    <label>Gabaritos por folha:
      <select id="perPage">
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>Tamanho das bolhas:
      <input type="range" id="bubbleSize" min="10" max="30" value="20">
      <span id="bubbleSizeValue">20</span>
    </label>

    <button onclick="printSheet()">Imprimir Cartão</button>
  </div>
</div>

<!-- Tela Escaneamento Cartão -->
<div id="escaneamentoScreen" style="display:none;">
  <div class="controls">
    <label>Upload das turmas (Excel .xlsx ou .csv):
      <input type="file" id="fileInput" multiple>
    </label>

    <label>Selecione a turma:
      <select id="selectClass">
        <option value="">-- Selecione --</option>
      </select>
    </label>

    <label>Selecione o aluno:
      <select id="selectStudent">
        <option value="">-- Selecione --</option>
      </select>
    </label>

    <label>Nº do aluno:
      <input type="text" id="studentNumber" readonly>
    </label>

    <button onclick="exportResults()">Exportar Excel</button>
  </div>
</div>

<div id="sheetContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let studentsData = {}; // {turma: [{numero,nome}, ...]}
let results = [];

// Alterna telas
function showScreen(screen){
  document.getElementById('gabaritoScreen').style.display = (screen==='gabarito')?'block':'none';
  document.getElementById('escaneamentoScreen').style.display = (screen==='escaneamento')?'block':'none';
}

// Upload Excel
document.getElementById('fileInput').addEventListener('change', function(e){
  const files = e.target.files;
  for(let f of files){
    const reader = new FileReader();
    reader.onload = function(ev){
      const data = new Uint8Array(ev.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet);
        studentsData[sheetName] = json.map(r => ({ numero: r['Nº'], nome: r['Nome'] }));
      });
      updateClassOptions();
    }
    reader.readAsArrayBuffer(f);
  }
});

function updateClassOptions(){
  const selectClass = document.getElementById('selectClass');
  selectClass.innerHTML = '<option value="">-- Selecione --</option>';
  Object.keys(studentsData).forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    selectClass.appendChild(opt);
  });
}

document.getElementById('selectClass').addEventListener('change', function(){
  const turma = this.value;
  const selectStudent = document.getElementById('selectStudent');
  selectStudent.innerHTML = '<option value="">-- Selecione --</option>';
  if(studentsData[turma]){
    studentsData[turma].forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.nome;
      opt.textContent = s.nome;
      selectStudent.appendChild(opt);
    });
  }
});

document.getElementById('selectStudent').addEventListener('change', function(){
  const turma = document.getElementById('selectClass').value;
  const aluno = this.value;
  if(turma && aluno){
    const student = studentsData[turma].find(s => s.nome===aluno);
    document.getElementById('studentNumber').value = student ? student.numero : '';
  }
});

// Slider bolhas
const bubbleSlider = document.getElementById('bubbleSize');
const bubbleValue = document.getElementById('bubbleSizeValue');
bubbleSlider.addEventListener('input', function(){
  const val = this.value;
  bubbleValue.textContent = val;
  updateSheet();
});

// Atualiza gabarito
function updateSheet() {
  const numQuestions = parseInt(document.getElementById('numQuestions').value);
  const numOptions = parseInt(document.getElementById('numOptions').value);
  const perPage = parseInt(document.getElementById('perPage').value);
  const bubbleSize = parseInt(document.getElementById('bubbleSize').value);
  const container = document.getElementById('sheetContainer');
  container.innerHTML = '';

  for(let i=0;i<perPage;i++){
    const page = document.createElement('div');
    page.className = 'page';
    if(perPage === 2){ page.style.width = '48%'; page.style.height = '95%'; }
    else if(perPage === 4){ page.style.width = '48%'; page.style.height = '48%'; }
    else{ page.style.width = '95%'; page.style.height = '95%'; }

    const aluno = document.getElementById('selectStudent').value;
    const numero = document.getElementById('studentNumber').value;
    const turma = document.getElementById('selectClass').value;

    const header = document.createElement('div');
    header.className = 'headerCard';
    header.innerHTML = `
      <div>
        Nome: ${aluno || '____________________________'}
        &nbsp;&nbsp; Nº: <span class="underline standard">${numero || '____'}</span>
      </div>
      <div style="margin-top:5px;">
        Turma: <span class="underline standard">${turma || '______'}</span>
      </div>
    `;
    page.appendChild(header);

    for(let q=1;q<=numQuestions;q++){
      const qDiv = document.createElement('div');
      qDiv.className = 'question';
      let optionsHtml = '';
      for(let o=0;o<numOptions;o++){
        const letter = String.fromCharCode(65+o);
        optionsHtml += `<label style="font-size:${bubbleSize}px"><input type="radio" name="q${q}_${i}" value="${letter}"> ${letter} </label>`;
      }
      qDiv.innerHTML = `${q}. ${optionsHtml}`;
      page.appendChild(qDiv);
    }
    container.appendChild(page);
  }
}

// Imprimir cartões
function printSheet() {
  window.print();
}

// Exportar Excel
function exportResults() {
  if(results.length===0){
    alert("Nenhum resultado registrado ainda.");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(results);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Resultados");
  XLSX.writeFile(wb, "Resultados.xlsx");
}

// Inicializa visualização ao carregar
updateSheet();

</script>
</body>
</html>
